<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CornVault - Digital Corn Economy</title>
  <meta name="description" content="Manage your digital corn assets and grow your virtual farm">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
<style>
  :root {
    --primary: #2ecc71;
    --primary-dark: #27ae60;
    --secondary: #3498db;
    --dark: #121212;
    --darker: #0d0d0d;
    --light: #f8f9fa;
    --gray: #2c3e50;
    --light-gray: #ecf0f1;
    --danger: #e74c3c;
    --warning: #f39c12;
    --success: #2ecc71;
    --border-radius: 12px;
    --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    --transition: all 0.3s ease;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    background: var(--dark);
    color: var(--light);
    line-height: 1.6;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Splash Screen */
  #splash {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--darker);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }

  .splash-content {
    text-align: center;
    animation: fadeIn 1s ease;
  }

  .splash-logo {
    font-size: 3rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .splash-icon {
    font-size: 4rem;
    animation: bounce 2s infinite;
  }

  /* Auth Container */
  .auth-container {
    max-width: 480px;
    margin: 2rem auto;
    padding: 2rem;
    background: var(--darker);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    display: none;
  }

  .auth-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .auth-logo {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .auth-title {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: var(--light);
  }

  .auth-subtitle {
    color: var(--light-gray);
    margin-bottom: 2rem;
  }

  /* Form Elements */
  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--light-gray);
    font-weight: 500;
  }

  .form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: var(--border-radius);
    color: var(--light);
    font-size: 1rem;
    transition: var(--transition);
  }

  .form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--border-radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    gap: 0.5rem;
  }

  .btn-primary {
    background: var(--primary);
    color: var(--dark);
  }

  .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: var(--gray);
    color: var(--light);
  }

  .btn-secondary:hover {
    background: #34495e;
    transform: translateY(-2px);
  }

  .btn-block {
    display: flex;
    width: 100%;
  }

  .btn-group {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
  }

  /* App Layout */
  .app-container {
    display: none;
    flex: 1;
    padding-bottom: 80px;
  }

  .app-header {
    background: var(--darker);
    color: var(--primary);
    padding: 1rem;
    font-size: 1.5rem;
    font-weight: 700;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .user-info {
    font-size: 1rem;
    color: var(--light);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .user-balance {
    font-weight: 600;
    color: var(--primary);
  }

  /* Sections */
  .section {
    margin: 1.5rem auto;
    max-width: 800px;
    background: var(--darker);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--box-shadow);
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    color: var(--primary);
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: 600;
  }

  .section-icon {
    font-size: 1.75rem;
  }

  .section-body {
    margin-top: 1rem;
  }

  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .stat-card {
    background: rgba(255,255,255,0.05);
    border-radius: var(--border-radius);
    padding: 1rem;
    text-align: center;
  }

  .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 0.25rem;
  }

  .stat-label {
    color: var(--light-gray);
    font-size: 0.875rem;
  }

  /* Field Section */
  .field-stats {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1.5rem;
  }

  .field-visual {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    justify-content: center;
  }

  .corn-icon {
    font-size: 2rem;
    color: #f1c40f;
    transition: transform 0.3s ease;
  }

  .corn-icon:hover {
    transform: scale(1.2);
  }

  /* Field Animation */
  .field-container {
    position: relative;
    width: 100%;
    height: 200px;
    margin: 1rem 0;
    overflow: hidden;
    border-radius: var(--border-radius);
    background: linear-gradient(to bottom, #5d4037, #8d6e63);
  }

  .field-ground {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 60px;
    background: linear-gradient(to bottom, #4e342e, #6d4c41);
  }

  .corn-plant {
    position: absolute;
    bottom: 60px;
    transform-origin: bottom;
    transition: all 1s ease;
  }

  .corn-stalk {
    stroke: #7cb342;
    stroke-width: 3;
    stroke-linecap: round;
  }

  .corn-ear {
    fill: #fdd835;
  }

  .corn-leaf {
    fill: #8bc34a;
  }

  /* Growth Animation */
  @keyframes grow {
    0% { transform: scaleY(0); opacity: 0; }
    100% { transform: scaleY(1); opacity: 1; }
  }

  /* PVP Section */
  .pvp-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .pvp-log {
    background: rgba(0,0,0,0.2);
    border-radius: var(--border-radius);
    padding: 1rem;
    margin-top: 1.5rem;
    min-height: 80px;
    font-family: 'Courier New', monospace;
    overflow-y: auto;
    max-height: 200px;
  }

  .pvp-log-entry {
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .pvp-log-entry.success {
    color: var(--success);
  }

  .pvp-log-entry.failure {
    color: var(--danger);
  }

  /* Navigation */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 70px;
    background: var(--darker);
    display: flex;
    justify-content: space-around;
    align-items: center;
    border-top: 1px solid rgba(255,255,255,0.1);
    z-index: 100;
    display: none;
  }

  .nav-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--light-gray);
    font-size: 0.875rem;
    cursor: pointer;
    transition: var(--transition);
    padding: 0.5rem;
    width: 100%;
    height: 100%;
  }

  .nav-btn i {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }

  .nav-btn.active {
    color: var(--primary);
  }

  .nav-btn:hover {
    color: var(--primary);
    transform: translateY(-3px);
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-20px); }
    60% { transform: translateY(-10px); }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .auth-container {
      margin: 1rem;
      padding: 1.5rem;
    }

    .section {
      margin: 1rem;
    }

    .stats-grid {
      grid-template-columns: 1fr 1fr;
    }

    .pvp-actions {
      grid-template-columns: 1fr;
    }
  }

  /* Utility Classes */
  .text-center {
    text-align: center;
  }

  .text-muted {
    color: var(--light-gray);
  }

  .mt-1 { margin-top: 0.5rem; }
  .mt-2 { margin-top: 1rem; }
  .mt-3 { margin-top: 1.5rem; }
  .mt-4 { margin-top: 2rem; }

  .mb-1 { margin-bottom: 0.5rem; }
  .mb-2 { margin-bottom: 1rem; }
  .mb-3 { margin-bottom: 1.5rem; }
  .mb-4 { margin-bottom: 2rem; }

  /* Loading Spinner */
  .spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body onload="startSplash()">
<!-- Splash Screen -->
<div id="splash">
  <div class="splash-content">
    <div class="splash-logo">
      <span>CornVault</span>
    </div>
    <div class="splash-icon">ðŸŒ½</div>
    <p class="text-muted">Growing your digital corn economy</p>
  </div>
</div>

<!-- Login/Signup Container -->
<div id="auth" class="auth-container" style="display:none;">
  <div class="auth-header">
    <div class="auth-logo">
      <span>CornVault</span>
    </div>
    <h2 class="auth-title" id="auth-title">Welcome Back</h2>
    <p class="auth-subtitle" id="auth-subtitle">Sign in to manage your corn assets</p>
  </div>

  <form id="auth-form">
    <div class="form-group">
      <label for="email" class="form-label">Email</label>
      <input type="email" id="email" class="form-control" placeholder="your@email.com" required>
    </div>

    <div class="form-group">
      <label for="password" class="form-label">Password</label>
      <input type="password" id="password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
    </div>

    <div class="btn-group">
      <button type="button" id="login-btn" class="btn btn-primary btn-block" onclick="login()">
        <i class="fas fa-sign-in-alt"></i> Sign In
      </button>
      <button type="button" id="signup-btn" class="btn btn-secondary btn-block" onclick="createAccount()">
        <i class="fas fa-user-plus"></i> Sign Up
      </button>
    </div>
  </form>
</div>

<!-- Main App Container -->
<div id="app" class="app-container">
  <!-- Header -->
  <header class="app-header">
    <div>CornVault</div>
    <div class="user-info">
      <i class="fas fa-coins"></i>
      <span>Balance: <span id="corns" class="user-balance">100.0000</span> CORN</span>
    </div>
  </header>

  <!-- Hub Section -->
  <section id="hub" class="section">
    <div class="section-header">
      <i class="fas fa-chart-line section-icon"></i>
      <h3 class="section-title">Economic Dashboard</h3>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="circulating-corns">1,234,567</div>
        <div class="stat-label">Corns in Circulation</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-players">128</div>
        <div class="stat-label">Active Farmers</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="user-level">Bronze</div>
        <div class="stat-label">Your Level</div>
      </div>
    </div>

    <div class="section-body">
      <canvas id="cornChart" height="250"></canvas>
    </div>
  </section>

  <!-- Field Section -->
  <section id="field" class="section" style="display:none;">
    <div class="section-header">
      <i class="fas fa-tractor section-icon"></i>
      <h3 class="section-title">Corn Field</h3>
    </div>
    
    <div class="field-stats">
      <div>
        <div class="stat-value" id="corn-count">0</div>
        <div class="stat-label">Planted Corns</div>
      </div>
      <div>
        <div class="stat-value" id="yield-rate">0.0003</div>
        <div class="stat-label">CORN per 5 sec</div>
      </div>
    </div>

    <div class="field-container" id="field-animation">
      <div class="field-ground"></div>
      <!-- Corn plants will be added here dynamically -->
      <div class="text-muted" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        Your field is empty. Plant some corn!
      </div>
    </div>

    <div class="btn-group">
      <button id="buyFieldBtn" class="btn btn-primary" onclick="buyField()">
        <i class="fas fa-landmark"></i> Buy Field (30 CORN)
      </button>
      <button id="buyCornBtn" class="btn btn-primary" onclick="buyCorn()" style="display:none;">
        <i class="fas fa-seedling"></i> Buy Corn (<span id="cornPrice">5.00</span> CORN)
      </button>
    </div>
  </section>

  <!-- PVP Section -->
  <section id="pvp" class="section" style="display:none;">
    <div class="section-header">
      <i class="fas fa-swords section-icon"></i>
      <h3 class="section-title">PVP Arena</h3>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">49.99%</div>
        <div class="stat-label">Success Rate</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">3</div>
        <div class="stat-label">Win Reward</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">5</div>
        <div class="stat-label">Attack Cost</div>
      </div>
    </div>

    <div class="section-body">
      <p class="text-muted">Challenge other farmers to steal their CORN. High risk, high reward!</p>
      
      <div class="pvp-actions">
        <button class="btn btn-primary" onclick="attack()" id="attack-btn">
          <i class="fas fa-bolt"></i> Attack (5 CORN)
        </button>
        <button class="btn btn-secondary" onclick="buyRepellent()">
          <i class="fas fa-shield-alt"></i> Buy Repellent (10 CORN)
        </button>
      </div>

      <div class="pvp-log" id="pvpLog">
        <div class="pvp-log-entry text-muted">Battle log will appear here...</div>
      </div>
    </div>
  </section>

  <!-- Terms Section -->
  <section id="terms" class="section" style="display:none;">
    <div class="section-header">
      <i class="fas fa-file-contract section-icon"></i>
      <h3 class="section-title">Terms & Conditions</h3>
    </div>
    
    <div class="section-body">
      <p>This is a digital simulation game. No real transactions are made within this application.</p>
      <p class="mt-2">All CORN assets are virtual and have no real-world value.</p>
      <p class="mt-2">By using this app, you agree to our terms of service and privacy policy.</p>
    </div>
  </section>

  <!-- Support Section -->
  <section id="support" class="section" style="display:none;">
    <div class="section-header">
      <i class="fas fa-headset section-icon"></i>
      <h3 class="section-title">Support</h3>
    </div>
    
    <div class="section-body">
      <p>Need help with your CornVault account?</p>
      
      <div class="mt-3">
        <a href="mailto:support@cornvault.com" class="btn btn-secondary">
          <i class="fas fa-envelope"></i> Email Support
        </a>
      </div>
    </div>
  </section>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav" id="navBar">
  <button class="nav-btn" onclick="show('hub')">
    <i class="fas fa-home"></i>
    <span>Dashboard</span>
  </button>
  <button class="nav-btn" onclick="show('field')">
    <i class="fas fa-tractor"></i>
    <span>Field</span>
  </button>
  <button class="nav-btn" onclick="show('pvp')">
    <i class="fas fa-swords"></i>
    <span>PVP</span>
  </button>
  <button class="nav-btn" onclick="show('terms')">
    <i class="fas fa-file"></i>
    <span>Terms</span>
  </button>
  <button class="nav-btn" onclick="show('support')">
    <i class="fas fa-headset"></i>
    <span>Support</span>
  </button>
</nav>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Game State
  let userCorns = parseFloat(localStorage.getItem("corns")) || 100.0;
  let hasField = localStorage.getItem("hasField") === "true";
  let cornCount = parseInt(localStorage.getItem("cornCount")) || 0;
  let cornHistory = [];
  let cornInterval;
  let historyInterval;
  let pvpSpinning = false;
  let cornBaseCost = 5.0;
  let cornChart;
  let chartNeedsUpdate = false;

  // Initialize the app
  function init() {
    updateCornsDisplay();
    updateCornCount();
    updateCornPrice();
    renderCornField();
    
    // Load history from localStorage if available
    const savedHistory = localStorage.getItem("cornHistory");
    if (savedHistory) {
      try {
        cornHistory = JSON.parse(savedHistory).map(item => ({
          time: new Date(item.time),
          value: item.value
        }));
      } catch (e) {
        console.error("Error loading history:", e);
        initializeDefaultHistory();
      }
    } else {
      initializeDefaultHistory();
    }
    
    // Start earning loop if already has field
    if (hasField) {
      startEarnings();
      document.getElementById('buyFieldBtn').style.display = 'none';
      document.getElementById('buyCornBtn').style.display = 'block';
    }
    
    startHistoryLogging();
    drawChart();
  }

  // Initialize default history if none exists
  function initializeDefaultHistory() {
    cornHistory = [];
    const now = Date.now();
    for (let i = 0; i < 10; i++) {
      cornHistory.push({
        time: new Date(now - (10 - i) * 5000),
        value: userCorns - (10 - i) * 0.0003
      });
    }
  }

  // Update CORN balance display
  function updateCornsDisplay(animated = false, gain = 0) {
    const el = document.getElementById("corns");
    el.innerText = userCorns.toFixed(4);
    localStorage.setItem("corns", userCorns);

    if (animated && gain > 0) {
      const anim = document.createElement("span");
      anim.innerText = ` +${gain.toFixed(4)}`;
      anim.style.color = "#2ecc71";
      anim.style.marginLeft = "5px";
      anim.style.fontWeight = "bold";
      el.parentElement.appendChild(anim);
      setTimeout(() => anim.remove(), 2000);
    }
  }

  // Update corn count display
  function updateCornCount() {
    document.getElementById('corn-count').textContent = cornCount;
    document.getElementById('yield-rate').textContent = (cornCount * 0.0003).toFixed(4);
  }

  // Update corn price based on current count
  function updateCornPrice() {
    const price = cornBaseCost * Math.pow(1.7, cornCount);
    document.getElementById("cornPrice").innerText = price.toFixed(2);
    return price;
  }

  // Render visual corn field with SVG animations
  function renderCornField() {
    const field = document.getElementById('field-animation');
    field.innerHTML = '<div class="field-ground"></div>';
    
    if (cornCount === 0) {
      const emptyMsg = document.createElement('div');
      emptyMsg.className = 'text-muted';
      emptyMsg.style.position = 'absolute';
      emptyMsg.style.top = '50%';
      emptyMsg.style.left = '50%';
      emptyMsg.style.transform = 'translate(-50%, -50%)';
      emptyMsg.textContent = 'Your field is empty. Plant some corn!';
      field.appendChild(emptyMsg);
      return;
    }
    
    // Remove empty message if exists
    const emptyMsg = field.querySelector('.text-muted');
    if (emptyMsg) field.removeChild(emptyMsg);
    
    // Calculate positions for corn plants
    const fieldWidth = field.clientWidth;
    const plantSpacing = fieldWidth / (cornCount + 1);
    
    for (let i = 0; i < cornCount; i++) {
      const plant = document.createElement('div');
      plant.className = 'corn-plant';
      plant.style.left = `${plantSpacing * (i + 1)}px`;
      plant.style.height = `${100 + Math.random() * 50}px`;
      
      // Create SVG for corn plant
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", "40");
      svg.setAttribute("height", "200");
      svg.setAttribute("viewBox", "0 0 40 200");
      
      // Stalk
      const stalk = document.createElementNS("http://www.w3.org/2000/svg", "path");
      stalk.setAttribute("d", "M20 200 L20 50");
      stalk.setAttribute("class", "corn-stalk");
      stalk.setAttribute("stroke-width", "3");
      
      // Ear of corn
      const ear = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
      ear.setAttribute("cx", "20");
      ear.setAttribute("cy", "40");
      ear.setAttribute("rx", "8");
      ear.setAttribute("ry", "15");
      ear.setAttribute("class", "corn-ear");
      
      // Leaves
      const leaf1 = document.createElementNS("http://www.w3.org/2000/svg", "path");
      leaf1.setAttribute("d", "M20 120 Q30 100 20 80");
      leaf1.setAttribute("class", "corn-leaf");
      
      const leaf2 = document.createElementNS("http://www.w3.org/2000/svg", "path");
      leaf2.setAttribute("d", "M20 120 Q10 100 20 80");
      leaf2.setAttribute("class", "corn-leaf");
      
      const leaf3 = document.createElementNS("http://www.w3.org/2000/svg", "path");
      leaf3.setAttribute("d", "M20 150 Q30 130 20 110");
      leaf3.setAttribute("class", "corn-leaf");
      
      const leaf4 = document.createElementNS("http://www.w3.org/2000/svg", "path");
      leaf4.setAttribute("d", "M20 150 Q10 130 20 110");
      leaf4.setAttribute("class", "corn-leaf");
      
      // Add elements to SVG
      svg.appendChild(stalk);
      svg.appendChild(ear);
      svg.appendChild(leaf1);
      svg.appendChild(leaf2);
      svg.appendChild(leaf3);
      svg.appendChild(leaf4);
      
      plant.appendChild(svg);
      field.appendChild(plant);
      
      // Animate growth
      plant.style.animation = "grow 1s ease forwards";
    }
  }

  // Start earning CORN from planted corn
  function startEarnings() {
    if (!cornInterval) {
      cornInterval = setInterval(() => {
        if (hasField && cornCount > 0) {
          const gain = cornCount * 0.0003;
          userCorns += gain;
          updateCornsDisplay(true, gain);
          chartNeedsUpdate = true;
          
          // Add visual effect for earning
          animateCornHarvest();
        }
      }, 5000);
    }
  }

  // Animate corn harvest effect
  function animateCornHarvest() {
    const field = document.getElementById('field-animation');
    const plants = field.querySelectorAll('.corn-plant');
    
    plants.forEach((plant, index) => {
      setTimeout(() => {
        const ear = plant.querySelector('.corn-ear');
        ear.style.transform = 'scale(1.1)';
        ear.style.transition = 'transform 0.3s ease';
        
        setTimeout(() => {
          ear.style.transform = 'scale(1)';
          
          // Create coin animation
          const coin = document.createElement('div');
          coin.innerHTML = 'ðŸŒ½';
          coin.style.position = 'absolute';
          coin.style.left = plant.style.left;
          coin.style.bottom = '60px';
          coin.style.fontSize = '20px';
          coin.style.animation = 'bounce 1s ease forwards';
          field.appendChild(coin);
          
          setTimeout(() => {
            coin.style.transform = 'translateY(-100px)';
            coin.style.opacity = '0';
            coin.style.transition = 'all 1s ease';
            
            setTimeout(() => {
              field.removeChild(coin);
            }, 1000);
          }, 300);
        }, 300);
      }, index * 100);
    });
  }

  // Log CORN history for chart
  function startHistoryLogging() {
    if (!historyInterval) {
      historyInterval = setInterval(() => {
        cornHistory.push({ time: new Date(), value: userCorns });
        if (cornHistory.length > 100) cornHistory.shift();
        
        // Save to localStorage
        localStorage.setItem("cornHistory", JSON.stringify(cornHistory));
        
        chartNeedsUpdate = true;
      }, 5000);
    }
  }

  // Draw chart (only when needed)
  function drawChart() {
    const ctx = document.getElementById('cornChart').getContext('2d');
    const labels = cornHistory.map(item => item.time.toLocaleTimeString());
    const data = cornHistory.map(item => item.value);

    if (cornChart) {
      // Only update data if chart exists
      cornChart.data.labels = labels;
      cornChart.data.datasets[0].data = data;
      cornChart.update();
    } else {
      // Create new chart if it doesn't exist
      cornChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'CORN Balance',
            data,
            borderColor: '#2ecc71',
            backgroundColor: 'rgba(46, 204, 113, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `${context.parsed.y.toFixed(4)} CORN`
              }
            }
          },
          scales: { 
            y: { 
              beginAtZero: false,
              ticks: {
                callback: (value) => `${value.toFixed(2)} CORN`
              }
            },
            x: {
              display: false
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }
    
    chartNeedsUpdate = false;
  }

  // Update chart periodically if needed
  setInterval(() => {
    if (chartNeedsUpdate && cornChart) {
      drawChart();
    }
  }, 1000);

  // Get random opponent name
  function getRandomOpponent() {
    const prefixes = ["Corn", "Harvest", "Golden", "Agro", "Field", "Kernel"];
    const suffixes = ["King", "Dream", "Crush", "Lord", "Farmer", "Master"];
    const number = Math.floor(Math.random() * 99).toString().padStart(2, '0');
    return `${prefixes[Math.floor(Math.random() * prefixes.length)]}${suffixes[Math.floor(Math.random() * suffixes.length)]}${number}`;
  }

  // Attack opponent in PVP
  function attack() {
    if (pvpSpinning) return;
    if (userCorns < 5) {
      addPvpLog("Not enough CORN to attack!", "failure");
      return;
    }

    pvpSpinning = true;
    const opponent = getRandomOpponent();
    userCorns -= 5;
    updateCornsDisplay();
    chartNeedsUpdate = true;

    const attackBtn = document.getElementById('attack-btn');
    attackBtn.innerHTML = '<span class="spinner"></span> Attacking...';
    attackBtn.disabled = true;

    setTimeout(() => {
      const chance = Math.random();
      const success = chance < 0.4999;
      const msg = success
        ? `Victory against ${opponent}! +3 CORN`
        : `Failed attack against ${opponent}.`;
      
      if (success) {
        userCorns += 3;
        updateCornsDisplay();
        chartNeedsUpdate = true;
        addPvpLog(msg, "success");
      } else {
        addPvpLog(msg, "failure");
      }
      
      attackBtn.innerHTML = '<i class="fas fa-bolt"></i> Attack (5 CORN)';
      attackBtn.disabled = false;
      pvpSpinning = false;
    }, 2000);
  }

  // Add entry to PVP log
  function addPvpLog(message, type = "info") {
    const log = document.getElementById('pvpLog');
    const entry = document.createElement('div');
    entry.className = `pvp-log-entry ${type}`;
    entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
    log.prepend(entry);
    
    // Keep log manageable
    if (log.children.length > 10) {
      log.removeChild(log.lastChild);
    }
  }

  // Buy repellent
  function buyRepellent() {
    if (userCorns < 10) {
      addPvpLog("Not enough CORN to buy repellent!", "failure");
      return;
    }
    userCorns -= 10;
    updateCornsDisplay();
    chartNeedsUpdate = true;
    addPvpLog("ðŸ›¡ï¸ Repellent purchased. Protects from 3 attacks.", "success");
  }

  // Buy field
  function buyField() {
    if (hasField) {
      alert("You already own a field.");
      return;
    }
    if (userCorns < 30) {
      alert("Not enough CORN to buy a field!");
      return;
    }
    userCorns -= 30;
    hasField = true;
    localStorage.setItem("hasField", "true");
    updateCornsDisplay();
    chartNeedsUpdate = true;
    
    document.getElementById('buyFieldBtn').style.display = 'none';
    document.getElementById('buyCornBtn').style.display = 'block';
    startEarnings();
    
    addPvpLog("ðŸŒ± Field purchased! You can now plant corn.", "success");
  }

  // Buy corn
  function buyCorn() {
    const price = updateCornPrice();
    if (userCorns < price) {
      alert("Not enough CORN to buy corn!");
      return;
    }
    userCorns -= price;
    cornCount += 1;
    localStorage.setItem("cornCount", cornCount.toString());
    updateCornsDisplay();
    updateCornCount();
    updateCornPrice();
    renderCornField();
    chartNeedsUpdate = true;
    
    addPvpLog(`ðŸŒ½ Corn planted! Total: ${cornCount}`, "success");
  }

  // Show section
  function show(section) {
    document.querySelectorAll(".section").forEach(s => s.style.display = "none");
    document.getElementById(section).style.display = "block";
    
    // Update active nav button
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = Array.from(document.querySelectorAll('.nav-btn')).find(btn => 
      btn.getAttribute('onclick').includes(section)
    );
    if (activeBtn) activeBtn.classList.add('active');
    
    // Only update chart when showing hub
    if (section === "hub" && cornChart) {
      drawChart();
    }
  }

  // Auth functions
  function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    
    if (!email || !password) {
      alert("Please enter both email and password.");
      return;
    }
    
    if (localStorage.getItem("email") === email && localStorage.getItem("password") === password) {
      startApp();
    } else {
      alert("Invalid credentials.");
    }
  }

  function createAccount() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    
    if (!email || !password) {
      alert("Please enter both email and password.");
      return;
    }
    
    localStorage.setItem("email", email);
    localStorage.setItem("password", password);
    localStorage.setItem("corns", "100.0");
    localStorage.setItem("hasField", "false");
    localStorage.setItem("cornCount", "0");
    localStorage.setItem("cornHistory", JSON.stringify([]));
    
    userCorns = 100.0;
    hasField = false;
    cornCount = 0;
    cornHistory = [];
    
    startApp();
  }

  // Start app after auth
  function startApp() {
    document.getElementById('splash').style.opacity = '0';
    setTimeout(() => {
      document.getElementById('splash').style.display = 'none';
      document.getElementById('auth').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('navBar').style.display = 'flex';
      
      init();
      show('hub');
    }, 500);
  }

  // Initialize splash screen
  function startSplash() {
    setTimeout(() => {
      document.getElementById('splash').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('splash').style.display = 'none';
        document.getElementById('auth').style.display = 'block';
      }, 500);
    }, 2000);
  }

  // Start the app
  startSplash();
</script>

<!-- Firebase Integration -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB1LoPAQ3pV53F5jUT5gAHmfCqodabrzoI",
    authDomain: "cornvault-35471.firebaseapp.com",
    projectId: "cornvault-35471",
    storageBucket: "cornvault-35471.appspot.com",
    messagingSenderId: "145895221221",
    appId: "1:145895221221:web:cf528adb1e31226798b10c",
    measurementId: "G-K3C48DXJ66"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Save user data
  async function saveUserData(uid, data) {
    await setDoc(doc(db, "users", uid), data);
  }

  // Load user data
  async function loadUserData(uid) {
    const docSnap = await getDoc(doc(db, "users", uid));
    return docSnap.exists() ? docSnap.data() : null;
  }

  // Firebase create account
  window.firebaseCreateAccount = async function(email, password) {
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;
      const initialData = { 
        corns: 100.0, 
        hasField: false, 
        cornCount: 0,
        cornHistory: [] 
      };
      await saveUserData(uid, initialData);
      window.firebaseStartApp(initialData);
    } catch (error) {
      alert("Error creating account: " + error.message);
    }
  }

  // Firebase login
  window.firebaseLogin = async function(email, password) {
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;
      const userData = await loadUserData(uid);
      if (userData) {
        window.firebaseStartApp(userData);
      } else {
        alert("No user data found.");
      }
    } catch (error) {
      alert("Login error: " + error.message);
    }
  }

  // Auth state listener
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const data = await loadUserData(user.uid);
      if (data) {
        window.firebaseStartApp(data);
      }
    }
  });

  // Firebase start app
  window.firebaseStartApp = function(data) {
    userCorns = data.corns;
    hasField = data.hasField;
    cornCount = data.cornCount;
    cornHistory = data.cornHistory || [];
    
    document.getElementById('splash').style.opacity = '0';
    setTimeout(() => {
      document.getElementById('splash').style.display = 'none';
      document.getElementById('auth').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('navBar').style.display = 'flex';
      
      init();
      show('hub');
    }, 500);
  };
</script>
</body>
</html>
